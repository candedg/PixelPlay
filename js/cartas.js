//-------------------------------------------------------------------------------------------------------------------
//MAZO DE CARTAS
function generarMazo() {
  return [
    {
      nombre: "1 de oros",
      imagen: "img/cartas/1oro.jpg",
      reverso: "img/cardback.png",
      valor: 1,
    },
    {
      nombre: "2 de oros",
      imagen: "img/cartas/2oro.jpg",
      reverso: "img/cardback.png",
      valor: 2,
    },
    {
      nombre: "3 de oros",
      imagen: "img/cartas/3oro.jpg",
      reverso: "img/cardback.png",
      valor: 3,
    },
    {
      nombre: "4 de oros",
      imagen: "img/cartas/4oro.jpg",
      reverso: "img/cardback.png",
      valor: 4,
    },
    {
      nombre: "5 de oros",
      imagen: "img/cartas/5oro.jpg",
      reverso: "img/cardback.png",
      valor: 5,
    },
    {
      nombre: "6 de oros",
      imagen: "img/cartas/6oro.jpg",
      reverso: "img/cardback.png",
      valor: 6,
    },
    {
      nombre: "7 de oros",
      imagen: "img/cartas/7oro.jpg",
      reverso: "img/cardback.png",
      valor: 7,
    },
    {
      nombre: "10 de oros",
      imagen: "img/cartas/10oro.jpg",
      reverso: "img/cardback.png",
      valor: 10,
    },
    {
      nombre: "11 de oros",
      imagen: "img/cartas/11oro.jpg",
      reverso: "img/cardback.png",
      valor: 10,
    },
    {
      nombre: "12 de oros",
      imagen: "img/cartas/12oro.jpg",
      reverso: "img/cardback.png",
      valor: 10,
    },

    {
      nombre: "1 de basto",
      imagen: "img/cartas/1basto.jpg",
      reverso: "img/cardback.png",
      valor: 1,
    },
    {
      nombre: "2 de basto",
      imagen: "img/cartas/2basto.jpg",
      reverso: "img/cardback.png",
      valor: 2,
    },
    {
      nombre: "3 de basto",
      imagen: "img/cartas/3basto.jpg",
      reverso: "img/cardback.png",
      valor: 3,
    },
    {
      nombre: "4 de basto",
      imagen: "img/cartas/4basto.jpg",
      reverso: "img/cardback.png",
      valor: 4,
    },
    {
      nombre: "5 de basto",
      imagen: "img/cartas/5basto.jpg",
      reverso: "img/cardback.png",
      valor: 5,
    },
    {
      nombre: "6 de basto",
      imagen: "img/cartas/6basto.jpg",
      reverso: "img/cardback.png",
      valor: 6,
    },
    {
      nombre: "7 de basto",
      imagen: "img/cartas/7basto.jpg",
      reverso: "img/cardback.png",
      valor: 7,
    },
    {
      nombre: "10 de basto",
      imagen: "img/cartas/10basto.jpg",
      reverso: "img/cardback.png",
      valor: 10,
    },
    {
      nombre: "11 de basto",
      imagen: "img/cartas/11basto.jpg",
      reverso: "img/cardback.png",
      valor: 10,
    },
    {
      nombre: "12 de basto",
      imagen: "img/cartas/12basto.jpg",
      reverso: "img/cardback.png",
      valor: 10,
    },

    {
      nombre: "1 de copa",
      imagen: "img/cartas/1copa.jpg",
      reverso: "img/cardback.png",
      valor: 1,
    },
    {
      nombre: "2 de copa",
      imagen: "img/cartas/2copa.jpg",
      reverso: "img/cardback.png",
      valor: 2,
    },
    {
      nombre: "3 de copa",
      imagen: "img/cartas/3copa.jpg",
      reverso: "img/cardback.png",
      valor: 3,
    },
    {
      nombre: "4 de copa",
      imagen: "img/cartas/4copa.jpg",
      reverso: "img/cardback.png",
      valor: 4,
    },
    {
      nombre: "5 de copa",
      imagen: "img/cartas/5copa.jpg",
      reverso: "img/cardback.png",
      valor: 5,
    },
    {
      nombre: "6 de copa",
      imagen: "img/cartas/6copa.jpg",
      reverso: "img/cardback.png",
      valor: 6,
    },
    {
      nombre: "7 de copa",
      imagen: "img/cartas/7copa.jpg",
      reverso: "img/cardback.png",
      valor: 7,
    },
    {
      nombre: "10 de copa",
      imagen: "img/cartas/10copa.jpg",
      reverso: "img/cardback.png",
      valor: 10,
    },
    {
      nombre: "11 de copa",
      imagen: "img/cartas/11copa.jpg",
      reverso: "img/cardback.png",
      valor: 10,
    },
    {
      nombre: "12 de copa",
      imagen: "img/cartas/12copa.jpg",
      reverso: "img/cardback.png",
      valor: 10,
    },

    {
      nombre: "1 de espada",
      imagen: "img/cartas/1espada.jpg",
      reverso: "img/cardback.png",
      valor: 1,
    },
    {
      nombre: "2 de espada",
      imagen: "img/cartas/2espada.jpg",
      reverso: "img/cardback.png",
      valor: 2,
    },
    {
      nombre: "3 de espada",
      imagen: "img/cartas/3espada.jpg",
      reverso: "img/cardback.png",
      valor: 3,
    },
    {
      nombre: "4 de espada",
      imagen: "img/cartas/4espada.jpg",
      reverso: "img/cardback.png",
      valor: 4,
    },
    {
      nombre: "5 de espada",
      imagen: "img/cartas/5espada.jpg",
      reverso: "img/cardback.png",
      valor: 5,
    },
    {
      nombre: "6 de espada",
      imagen: "img/cartas/6espada.jpg",
      reverso: "img/cardback.png",
      valor: 6,
    },
    {
      nombre: "7 de espada",
      imagen: "img/cartas/7espada.jpg",
      reverso: "img/cardback.png",
      valor: 7,
    },
    {
      nombre: "10 de espada",
      imagen: "img/cartas/10espada.jpg",
      reverso: "img/cardback.png",
      valor: 10,
    },
    {
      nombre: "11 de espada",
      imagen: "img/cartas/11espada.jpg",
      reverso: "img/cardback.png",
      valor: 10,
    },
    {
      nombre: "12 de espada",
      imagen: "img/cartas/12espada.jpg",
      reverso: "img/cardback.png",
      valor: 10,
    },
  ];
}
let mazo = generarMazo();
//-------------------------------------------------------------------------------------------------------------------

// Selección de elementos del DOM
const ingresarNombre = document.querySelector(".nombre-jugador-cartas");
const interfazCartas = document.querySelector(".interfaz-cartas");
const tituloJugador = document.querySelector(".titulo-jugador");
const btnComenzar = document.querySelector("#comenzar");
const btnIniciarTurno = document.querySelector("#iniciar-turno");
const btnJugarCarta = document.querySelector("#jugar-carta");
const parrafoApuesta = document.querySelector(".parrafo-apuesta");
const opcionesApuesta = document.querySelector(".opciones-apuesta");
const seccionResultados = document.querySelector("#resultados");
const mostrarRondas = document.querySelector(".contador-rondas");
const rondasGanadasJugador = document.querySelector("#rondas-jugador");
const rondasGanadasComputadora = document.querySelector("#rondas-computadora");
const puntosJugador = document.querySelector("#puntos-jugador");
const puntosComputadora = document.querySelector("#puntos-computadora");
const radioButtons = document.querySelectorAll(".radio-buttons");
const mensajeFinal = document.querySelector(".mensaje-final");
const btnNuevoTurno = document.querySelector("#nuevo-turno");
const btnSiguienteTurno = document.querySelector("#siguiente-turno");
const labelApuesta = document.querySelector("#label-apuesta");

let nombreJugador;
let indiceCartaJugador = null;
let cartaSeleccionadaJugador;
let jugadores = [];
let cartasJugador = [];
let cartasComputadora = [];
let apuesta;
let contadorRondas = 0;
let puntosAcumuladosJugador = 0;
let puntosAcumuladosComputadora = 0;
let contadorRondasParcialesJugador = 0;
let contadorRondasParcialesComputadora = 0;
let contadorRondasTotalesJugador = 0;
let contadorRondasTotalesComputadora = 0;
let indiceCartaComputadora = 0;

let ganadorCartas;
// Obtener la fecha actual
let fechaActual = new Date();

// Obtener partes de la fecha (día, mes, año, hora, etc.)
let dia = fechaActual.getDate(); // Día del mes
let mes = fechaActual.getMonth() + 1; // Mes (0 es enero, por eso sumamos 1)
let año = fechaActual.getFullYear(); // Año completo
let fechaFormateada; //donde se va a guardar la fecha si hay un ganador
//FUNCIONES-----------------------------------------------------------------------

// Función para guardar el nombre del jugador y actualizar la interfaz
function guardarJugador() {
  nombreJugador = document.querySelector("#nombre-jugador").value.trim().toLowerCase(); 
  //trim se asegura que no haya espacios en blanco, toLowerCase mantiene todo en minusculas
  // console.log(nombreJugador);
  // Si el valor ingresado está vacío o mediante parseInt puede ser convertido completamente a número, 
  // osea que solamente contiene numero, no sirve
  if (nombreJugador === "" || parseInt(nombreJugador) == nombreJugador) {
    alert("Por favor, ingresa un nombre válido");
    return;
  }

  ingresarNombre.style.display = "none";
  interfazCartas.style.display = "block";
  tituloJugador.textContent = nombreJugador;
}

// Función para seleccionar una carta aleatoria del mazo
//selecciona una carta al azar del mazo y la remueve para que no se repitan
function seleccionarCartaAleatoria(mazo) {
  const indiceAleatorio = Math.floor(Math.random() * mazo.length);
  const cartaSeleccionada = mazo[indiceAleatorio];
  mazo.splice(indiceAleatorio, 1); // Removemos la carta del mazo para evitar duplicados
  return cartaSeleccionada;
}

// Función para repartir las cartas al jugador y la computadora
function repartirCartas() {
  if (mazo.length <= 5) {
    mazo = generarMazo(); //si el mazo tiene menos de 6 cartas lo genera de nuevo
  }
  for (let i = 0; i < 3; i++) {
    cartasJugador.push(seleccionarCartaAleatoria(mazo)); // Seleccionamos una carta para el jugador
    cartasComputadora.push(seleccionarCartaAleatoria(mazo)); // Seleccionamos una carta para la computadora
  }

  mostrarCartas(cartasJugador, cartasComputadora);
}

// Función para mostrar las imagenes de las cartas correspondientes en la interfaz
function mostrarCartas(cartasJugador, cartasComputadora) {
  document.querySelector(".carta1").src = cartasJugador[0].imagen;
  document.querySelector(".carta2").src = cartasJugador[1].imagen;
  document.querySelector(".carta3").src = cartasJugador[2].imagen;

  document.querySelector("#carta1-computadora").src = cartasComputadora[0].reverso;
  document.querySelector("#carta2-computadora").src = cartasComputadora[1].reverso;
  document.querySelector("#carta3-computadora").src = cartasComputadora[2].reverso;
}

// Función para el inicio del turno
function iniciarTurno() {
  apuesta = parseInt(document.querySelector("#apuesta").value);
  labelApuesta.style.display = "none";
  for (let i = 0; i < radioButtons.length; i++) {
    radioButtons[i].style.visibility = "visible";
  }
  btnIniciarTurno.style.display = "none";
  opcionesApuesta.style.display = "none";
  parrafoApuesta.textContent = `Tu apuesta es de ${apuesta} puntos`;
  parrafoApuesta.style.display = "block";
  btnJugarCarta.style.display = "block";
}

// Función para manejar el juego de carta
function jugarCarta() {
  let seleccionado = false;
  for (let i = 0; i < radioButtons.length; i++) {
    if (radioButtons[i].checked) {
      seleccionado = true;
      cartaSeleccionadaJugador = cartasJugador[i]; // Asigna la carta seleccionada
      indiceCartaJugador = i; // Guardamos el índice de la carta seleccionada
      break;
    }
  }

  if (seleccionado) {
    // Seleccionar la primera carta del array de la computadora en orden
    if (indiceCartaComputadora < cartasComputadora.length) {
      let cartaSeleccionadaComputadora =
        cartasComputadora[indiceCartaComputadora];
      indiceCartaComputadora++; // Avanzar al siguiente índice para la próxima ronda

      // Comparar los valores de las cartas
      let valorJugador = cartaSeleccionadaJugador.valor;
      let valorComputadora = cartaSeleccionadaComputadora.valor;

      // Determinar el ganador y actualizar los contadores globales
      if (valorJugador > valorComputadora) {
        alert("¡Ganaste esta ronda!");
        contadorRondasParcialesJugador++;
        contadorRondasTotalesJugador++; // Actualiza el contador
      } else if (valorJugador < valorComputadora) {
        alert("La computadora ganó esta ronda.");
        contadorRondasParcialesComputadora++;
        contadorRondasTotalesComputadora++; // Actualiza el contador
      } else {
        alert("Es un empate.");
        contadorRondasParcialesJugador++; // En empate, cuenta una ronda ganada para ambos
        contadorRondasParcialesComputadora++;
        contadorRondasTotalesJugador++;
        contadorRondasTotalesComputadora++;
      }

      // Mostrar la carta de la computadora en la interfaz
      let imgComputadora = document.querySelector(`#carta${indiceCartaComputadora}-computadora`);
      imgComputadora.src = cartaSeleccionadaComputadora.imagen;

      // Ocultar el radio button de la carta seleccionada por el jugador
      radioButtons[indiceCartaJugador].style.visibility = "hidden"; // Oculta el botón de radio
      radioButtons[indiceCartaJugador].disabled = true; // Deshabilita el botón de radio

      // Mostrar cuántas rondas se van jugando
      contadorRondas++;
      seccionResultados.classList.remove("oculto");
      mostrarRondas.textContent = `Rondas jugadas: ${contadorRondas}`;

      // Actualizar los contadores de rondas ganadas en la interfaz
      rondasGanadasJugador.textContent = contadorRondasTotalesJugador;
      rondasGanadasComputadora.textContent = contadorRondasTotalesComputadora;

      // Reiniciar la selección de radio buttons
      for (let i = 0; i < radioButtons.length; i++) {
        radioButtons[i].checked = false;
      }
      revisarFinDelJuego();
    }
  } else {
    alert("Por favor, selecciona una carta antes de jugar.");
  }
}

//Función para verificar el fin del juego
function revisarFinDelJuego() {
  if (contadorRondas % 3 === 0) {
    if (contadorRondasParcialesJugador > contadorRondasParcialesComputadora) {
      puntosAcumuladosJugador += apuesta * 2;
    } else if (contadorRondasParcialesJugador < contadorRondasParcialesComputadora) {
      puntosAcumuladosComputadora += apuesta * 2;
    } else {
      puntosAcumuladosJugador += apuesta;
      puntosAcumuladosComputadora += apuesta;
    }
    mostrarResultadosParciales();
    if (puntosAcumuladosComputadora >= 50 || puntosAcumuladosJugador >= 50) {
      mostrarResultadosFinales();
    }
    contadorRondasParcialesComputadora = 0; //resetear el contador por turno
    contadorRondasParcialesJugador = 0;
  }
}

// Función para mostrar resultados parciales
function mostrarResultadosParciales() {
  btnJugarCarta.style.display = "none";
  btnSiguienteTurno.style.display = "block";
  btnNuevoTurno.style.display = "none";
  rondasGanadasJugador.textContent = contadorRondasTotalesJugador;
  rondasGanadasComputadora.textContent = contadorRondasTotalesComputadora;
  puntosJugador.textContent = puntosAcumuladosJugador;
  puntosComputadora.textContent = puntosAcumuladosComputadora;
}

// Función para mostrar los resultados finales
function mostrarResultadosFinales() {
  btnJugarCarta.style.display = "none";
  btnSiguienteTurno.style.display = "none";
  btnNuevoTurno.style.display = "block";
  if (puntosAcumuladosJugador > puntosAcumuladosComputadora) {
    mensajeFinal.style.display = "block";
    mensajeFinal.classList.add("verde");
    mensajeFinal.classList.remove("rojo");
    mensajeFinal.classList.remove("amarillo");
    // Formatear la fecha
    fechaFormateada = `${dia}/${mes}/${año}`;
    agregarGanadorCartas();
    mensajeFinal.innerHTML =
      'Felicitaciones ¡ganaste! <br> Revisa la <a href="posiciones.html" class = "btn-posiciones">tabla de posiciones</a> para averiguar si superaste el récord <br> ¿Vamos de nuevo?';
  } else if (puntosAcumuladosJugador < puntosAcumuladosComputadora) {
    mensajeFinal.style.display = "block";
    mensajeFinal.classList.remove("verde");
    mensajeFinal.classList.add("rojo");
    mensajeFinal.classList.remove("amarillo");
    mensajeFinal.innerHTML =
      'Lo siento, perdiste este juego <br> ¿Lo intentamos otra vez?';
  } else {
    mensajeFinal.style.display = "block";
    mensajeFinal.classList.remove("verde");
    mensajeFinal.classList.remove("rojo");
    mensajeFinal.classList.add("amarillo");
    mensajeFinal.innerHTML =
      'Parece que es un empate. <br> ¿Quieres la revancha?';
  }
}

//Funcion para siguiente turno
function turnoSiguiente() {
  //Ocultar boton de siguiente turno
  btnSiguienteTurno.style.display = "none";
  // Limpiar las cartas de los jugadores
  cartasJugador = [];
  cartasComputadora = [];

  // Reiniciar el índice de las cartas de la computadora
  indiceCartaComputadora = 0;

  // Volver a mostrar el botón de inicio de turno y ocultar los botones de juego
  btnIniciarTurno.style.display = "block";
  btnJugarCarta.style.display = "none";

  // Volver a mostrar los radio buttons
  for (let i = 0; i < radioButtons.length; i++) {
    radioButtons[i].disabled = false; // Habilitar los botones de radio
  }

  // Limpiar la selección de radio buttons
  for (let i = 0; i < radioButtons.length; i++) {
    radioButtons[i].checked = false;
  }

  //Limpiar apuesta
  labelApuesta.style.display = "block";
  apuesta = 0;
  opcionesApuesta.style.display = "block";
  parrafoApuesta.style.display = "none";

  // Volver a mostrar las cartas
  repartirCartas(); // Repartir nuevas cartas para el nuevo turno
  // Mostrar las cartas del jugador y de la computadora nuevamente
  mostrarCartas(cartasJugador, cartasComputadora);
}

// Función para reiniciar los valores para un nuevo turno
function nuevoTurno() {
  // Limpiar las cartas de los jugadores
  cartasJugador = [];
  cartasComputadora = [];

  // Volver a mostrar las cartas
  repartirCartas(); // Repartir nuevas cartas para el nuevo turno
  // Mostrar las cartas del jugador y de la computadora nuevamente
  mostrarCartas(cartasJugador, cartasComputadora);

  // Reiniciar el índice de las cartas de la computadora
  indiceCartaComputadora = 0;

  // Reiniciar los contadores de rondas
  contadorRondas = 0;
  contadorRondasParcialesJugador = 0;
  contadorRondasParcialesComputadora = 0;
  contadorRondasTotalesJugador = 0;
  contadorRondasTotalesComputadora = 0;
  puntosAcumuladosComputadora = 0;
  puntosAcumuladosJugador = 0;

  // Limpiar los resultados de las rondas previas
  mostrarRondas.textContent = `Rondas jugadas: ${contadorRondas}`;
  rondasGanadasJugador.textContent = contadorRondasTotalesJugador;
  rondasGanadasComputadora.textContent = contadorRondasTotalesComputadora;
  puntosJugador.textContent = "";
  puntosComputadora.textContent = "";
  mensajeFinal.style.display = "none";

  // Volver a mostrar el botón de inicio de turno y ocultar los botones de juego
  btnIniciarTurno.style.display = "block";
  btnJugarCarta.style.display = "none";
  seccionResultados.classList.add("oculto");

  // Volver a mostrar los radio buttons
  for (let i = 0; i < radioButtons.length; i++) {
    radioButtons[i].disabled = false; // Habilitar los botones de radio
  }

  // Limpiar la selección de radio buttons
  for (let i = 0; i < radioButtons.length; i++) {
    radioButtons[i].checked = false;
  }

  //Limpiar apuesta
  labelApuesta.style.display = "block";
  apuesta = 0;
  opcionesApuesta.style.display = "block";
  parrafoApuesta.style.display = "none";
}

//BOTONES-------------------------------------------------------------------------------
if (location.href.includes("cartas.html")) {
  // Evento del botón Comenzar
  btnComenzar.addEventListener("click", function (e) {
    e.preventDefault();
    guardarJugador();
    repartirCartas();
  });
  // Evento del botón Iniciar Turno
  btnIniciarTurno.addEventListener("click", function (e) {
    e.preventDefault();
    iniciarTurno();
  });
  // Evento del botón Jugar carta
  btnJugarCarta.addEventListener("click", function (e) {
    e.preventDefault();
    jugarCarta();
  });
  // Evento del botón Siguiente Turno
  btnSiguienteTurno.addEventListener("click", function (e) {
    e.preventDefault();
    turnoSiguiente();
  });

  // Evento del botón Nuevo Turno
  btnNuevoTurno.addEventListener("click", function (e) {
    e.preventDefault();
    nuevoTurno();
  });
}


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//---------------------------------------------------------------------
//PARA TABLA DE POSICIONES
//---------------------------------------------------------------------

//Funciones para guardar los mejores resultados en el localStorage

//Recupero el string de mejores resultados del localStorage
let resultadosLocalesCartas = localStorage.getItem("posicionesCartas");
//Lo vuelvo a convertir en un array o lo inicializo como array vacion en caso de que n haya ningun dato guradado
let resultadosCartas = JSON.parse(resultadosLocalesCartas) || [];

function agregarGanadorCartas() {
  // Creo un objeto con los resultados del último juego
  const ganadorCartas = {
    nombre: nombreJugador,
    puntos: puntosAcumuladosJugador,
    rondas: contadorRondas,
    fecha: fechaFormateada
  };
  // console.log(ganadorCartas); sirev para revisar si se registró correctamente el ganador reciente


  // Verificar si el jugador ya existe
  let jugadorExistenteCartas = null;
  for (let i = 0; i < resultadosCartas.length; i++) {
    if (resultadosCartas[i].nombre === nombreJugador) {
      jugadorExistenteCartas = resultadosCartas[i];
      break;
    }
  }

  if (jugadorExistenteCartas) {
    // Si el jugador existe, solo actualizar si la nueva puntuación es mejor (menos rondas)
    if (ganadorCartas.rondas < jugadorExistenteCartas.rondas) {
      jugadorExistenteCartas.rondas = ganadorCartas.rondas;
      jugadorExistenteCartas.fecha = ganadorCartas.fecha; // Actualizar fecha si se mejora
      jugadorExistenteCartas.puntos = ganadorCartas.puntos; // Actualizar puntos nuevos
    }
  } else {
    // Agregar nuevo ganador
    resultadosCartas.push(ganadorCartas);
  }

  // Evaluar dónde añadir el nuevo ganador
  // Ordenar por turnos (menor es mejor)
  let insertado = false;
  for (let i = 0; i < resultadosCartas.length; i++) {
    if (ganadorCartas.rondas < resultadosCartas[i].rondas) {
      // Insertar el nuevo resultado en la posición correcta
      resultadosCartas.splice(i, 0, ganadorCartas);
      insertado = true;
      break;
    }
  }

  // Si se añadió un nuevo resultado y quedaron más de 10, se elimina el último
  if (resultadosCartas.length > 10) {
    resultadosCartas.pop();
  }

  // Guardar el resultado actualizado en localStorage
  localStorage.setItem("posicionesCartas", JSON.stringify(resultadosCartas));
  // console.log(resultadosCartas); sirve para revisar si se guardo en el localStorage
}

